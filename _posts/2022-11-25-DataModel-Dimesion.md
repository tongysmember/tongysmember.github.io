---
layout: post
toc: true
title: "[讀書筆記] 數據倉儲工具箱:維度建模指南"
categories: DataModel
tags: [DataModel]
---
# 數據倉儲工具箱:維度建模指南

# Ch1. 數據倉儲, 商業智慧及維度建模

## 1.1 簡介

- 定義OLTP, OLAP 差異: 交易型, 分析型
- DW / BI 目標, 優點:
    - 方便使用 / 迅速讀取
    - 一致性展示
    - 適應快速變化
    - DW/BI系統成為提高決策能力的權威與可信度的基礎
- 維度模型簡介:
    - 以商業用戶可理解的方式發布數據
    - 提供高效能的查詢結果
    - **不要求**滿足第三正規化(一個關聯表為第三正規化表格，若且唯若該關聯表中，不存在非鍵值屬性遞移相依於主鍵)
    
    ![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled.png)
    
- Star Schema / OLAP 多維資料庫
    
    ![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%201.png)
    
    - Star Schema: RMDBS實現的維度模型稱作星狀模式, 參考上圖左方, 透過關聯方式連接不同維度.
    - OLAP: 將資料使用**設計後的格式與技術**, 將彙整成資料表並管理. 能夠使用計算, 索引等相關優化方式, 實現高性能的查詢.
    - 書中建議: Atomic 的訊息載入星型模式, 將多維度OLAP 移植至**星狀模式**中.

## 1.2 事實表 (FACT):用於呈現度量的連續事件

事實表示某個業務的肚量, 舉例: 銷售度量為商品被販售的事件,

注意: 真實世界中**每一個度量事件都是與對應的事實表具有一對一的關係**, 這一個觀念是維度建模的基本原則.

常見: 數值類型, 可加類型, 半可加類型, 不可加類型

舉例: 數值類型⇒商品銷售金額,   可加類型⇒ 當月營業總額, 半可加類型⇒ 當周帳戶結餘, 不可加類型 ⇒ 商品單位價格, 商品列別

連續型敘述: 在週期當中以連續事件進行, 用於區分是否為事實表或為度表

資料上提醒: 

- 盡量將維度資訊化分出事實表, 避免空間開銷
- 避免將 0 視為無事件發生, 會造成分析資料的稀疏性問題

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%202.png)

## 1.3 維度表 (DIM):用於敘述環境資訊

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%203.png)

用於描述: Who, Where, When, How, Why

注意: 維度表作為數據的起始點, 提供所有 DW / BI **分析的標籤與分組**

主鍵 PK: 僅有單一主鍵

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%204.png)

能夠呈現完整性資訊, 透過事件表整合出完整資訊.

簡化: 不一定要滿足第三正規化, 因為在星狀或 Snow-Flake 狀態下能夠讓使用者更易於理解內容

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%205.png)

## 1.4 星狀結構:

簡單性: 提供使用者易於理解的圖形架構與說明, 避免錯誤產生

顆粒度: 最小原子性提供最多變化, 使用者能夠產生多種組合結果. 

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%206.png)

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%207.png)

## 1.5 DW/BI 架構:

四種功能組成:

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%208.png)

1. OLTP: ERP, 一般日用系統, 作為來源資料.
2. ETL: 資料處裡, 需要高效, 品質與完整性, 一致性.
3. 數據展現: 透過倉儲方式讓使用者更方便存取相關資料, 提供設計與統整後完整的資料, 確保使用者得到一致的資訊.
4. BI應用

## 1.6 其他架構

Data Mart: 基於特定目標滿足相關人員需求. 將來源資料統整至 Mart 當中, 但初始期間尚未統整度量單位, 跨單位/組織時提供不同整合資料, 其中ETL 有可能出現不一致現象; 此方式成本低, 開發快. 

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%209.png)

# Ch 2. 建模概要

## 2.1 概念:

1. 確認需求
2. 流程:
    1. 選擇商業流程
    2. 確認資料顆粒度
    3. 確認為度 DIM
    4. 確認事實 FACT
3. 業務過程: 了解 Domain 相關定義與活動流程
4. 資料顆粒度: 資料事件越細小能夠提供用戶使用上的變化性
5. 環境維度: Who, When,Where, How, Why?

## 2.2 事實表:

1. 類型: 可加, 半可加, 不可加
2. FK 內容不能為空直, 違反參照可能性, 需用默認行(代理鍵)
3. 一致性事實

類型:

1. 事件事實表: 發生當下事實表
2. 週期快照事實表: 天, 周, 月, 未發生事件則填寫0或空直列.
3. 累積快照事實表: 確立起始, 結束, 建立週期內事件表
    
    ![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%2010.png)
    

## 2.3 維度表:

2.3.1 維度表結構: 

- 單一主鍵 PK
- 小顆粒度的文本資訊
- 下鑽: 在分析過程中, 將原先取得資料更細部化分出內容資訊, 藉由此方式取得增加一個維度的資訊.
- Snow Flake: 透過多重維度將資訊串接, 建立多層次結構. 優點: 確保數據顆粒度”小”, 缺點: 結構複雜, 難理解, 影響效能

2.3.2 處理緩慢維度

- 類型0: 原樣保留
- 類型1: 更新
- 類型2: 新增新行, 透過時間欄位控管有效性

# Ch 3. 電信產業案例

## 3.1 產業與維度矩陣

文章中著重於記帳流程, 並針對不同維度進行展開, 透過下表行列矩陣能了解各流程之間關係.

本流程採用 OLTP 電話計費系統, 以每組**電話號碼**作為計費單的 Prime Key, 客戶可能會有多組電話號碼.   

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%2011.png)

書中提出初始資料模型, 請讀者提出建議並修訂.

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%2012.png)

## 3.2 設計考量

3.2.1 業務需求與實際可用資源的權衡

在初始當中所洽談的分析需求, 與實際接收 OLTP 來源資料會有部分差異, 因此需要綜觀分析與資料面向等進行取捨.

3.2.2 關注業務過程

維度模型應反映組織的主要業務流程與事件, 而非為特定報表或特定問題設計.

以流程作為設計上的優點, 能夠避免未來需求上的異動, 而造成設計上的影響.

3.3.3 資料顆粒度

探討: 事實表的顆粒度應該設置為多小?

建議: Raw Data 當中最小顆粒度, 符合未來分析需求的異動.

3.3.4 統一的事實表顆粒度

- 不同的事實表應保持相同顆粒度, 所有可相加的事實表應保持相同顆粒度, 提供未來操作上整合, (Ex: 時間單位為年的事實表/時間單位為分的事實表, 無法良好與快速整合)
- 禁止在事實表使用文字說明, 應轉換至維度表當中呈現.

3.3.5 維度的顆粒度和層次

各維度表盡量保持相同顆粒度, 並將其反正規化, 能夠幫助 OLAP 上增快取得資料速度; 若事實表串接超過 20 個維度表時, 應考慮對該維度表進行整合或劃分. 

- 雪花式 Snow-Flake: 節省空間, 增加複雜/查詢效能.
- 星狀 Star: 增加空間, 提升查詢效能.

3.3.6 日期維度

事實表當中所包含日期維度的外鍵, 建議可以將日期劃分出維度, 提供更多分析的可能性(EX: 週休, 國定假日, 工作日…) 

3.3.7 退化維度 [Degenerate Dimension](https://blog.csdn.net/wzy0623/article/details/49797421)

將維度表當中主題與事實表主題合併, 相同整合至事實表內.

3.3.8 代理鍵

[在建模中通過一些毫無意義鍵值來代替一些業務鍵值，有利於維度統一整合。](https://www.finereport.com/tw/knowledge/acquire/skill.html)

3.3.9 維度解碼與描述性代碼表

透過建立相關代碼, 能夠在分析或篩選資料時, 提供更為方便的查詢. EX: 標籤, 分類代碼

3.3.10 一致性

[通過在數據轉換處理環節一次性處理後，在構建不同數據集市、不同數據層時可以反覆被使用。](https://www.finereport.com/tw/knowledge/acquire/skill.html)

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%2013.png)

## 3.4 設計評審

在此段落提出設計討論時, 相關成員應遵守相關規則與如何使討論流程更順暢的細節.

## 3.5 成員評審後新的資料模型

1. 顆粒度: 每月帳單整併一列 ⇒ 來源系統每月當中各項服務皆為一列
2. 維度調整: 帳單日期維度修正為更多資訊(假日/工作日/週休…)
3. 維度整併: 將銷售組織/銷售管道 相同性質整併至單一維度表
4. 將代碼表當中代碼作為主鍵值的設計, 轉換為代理鍵

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%2014.png)

# Ch. 17 DW/BI 生命週期概要

## 17.1 RoadMap (Best Pratice)

當項目建立時, 將明確定義出相關需求, 需與項目規權衡後取得最佳的效果. 

再以三個工項平行建立:

1. 技術: 工具, 使用產品, 建置
2. 建模: 按照需求進行相關維度建模分析, 並建立相關ETL 流程工項
3. BI 應用: 參考商業需求進行開發

將上述三種工項完成後整併, 進至部屬環境上線, 後續將進入維護/開發階段循環

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%2015.png)

## 17.2 初始活動

1. 專案管理準備:
    1. 評估/準備 專案難度/執行性
    2. 範疇/驗證方式
    3. 參與人員
    4. 開發與維護
2. 需求評定會議/產生相關文件: 講述需求如何確認與討論方法/最終產生需求文檔

## 17.3 技術

1. 技術架構設計: 相關人員討論(ETL/建模人員/BI)
2. 架構需求文件化
3. 建立 Framework
4. 確立實施階段
5. 相關子系統

## 17.4 資料生命週期

1. 維度建模
2. Physical 實體設計:
    1. 命名標準
    2. 資料庫建立
    3. 索引規劃
    4. 設計聚合
    5. 資料存放細節: 存放位置/方式/查詢
3. ETL 設計與開發

## 17.5 BI 應用

- 終端商業分析使用者, 能夠藉由倉儲資料提供分析資訊

### 17.5.1 BI 應用開發:

- 透過最小幅度的修訂, 能夠提供未來的使用

# Ch. 18 維度建模過程與任務

Def: 

- 維度建模過程
- 建模任務的策略
- 關鍵建模的產出(發布物)

## 18.1 建模過程

透過”高級維度模型”討論與設計出第一版共識, 後續需要將內部細節(Attribute, Domain, RelationShip….)討論, 並透過反覆迭代討論出最終的文本.

![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%2016.png)

## 18.2 組織工作

1. 確立相關工作人員
2. 業務需求理解與確認: 認知與想法上確認, 理解 User 需求.
3. 使用建模工具(Erwin): 方便性考量.
4. 使用數據分析工具: 在建模過程中, 也可以透過 SQL, Data Profiling 確認實體資料的樣貌, 有時會遇到文件提供資料未完全, 因此需採用相關工具分析.
5. 定義命名規則

## 18.3 維度模型設計

- 參考 Ch2 提到流程: [https://www.notion.so/c52023a137a94998a86275f2a9002798#b30b4b94fc2c46c7acf7a3be68a7a83d](https://www.notion.so/1-11ae22a71e0c4e9b8e8be4ca9929968b)
    1. 選擇商業流程
    2. 確認資料顆粒度
    3. 確認為度 DIM
    4. 確認事實 FACT
- 工作項目與交付物
    - 定義模型範圍粒度, 高級模型範疇
    - 設計表的屬性與度量
    - IT單位與業務單位的驗收
    - 文件檔案交付
- 高級模型圖示:
    - 初步討論的共識將產生高級模型圖, 提供評審小組確認
    - 維度: 大部分在確認顆粒度後, 將能夠產生相關維度表
    
    ![Untitled](%E6%95%B8%E6%93%9A%E5%80%89%E5%84%B2%E5%B7%A5%E5%85%B7%E7%AE%B1%20%E7%B6%AD%E5%BA%A6%E5%BB%BA%E6%A8%A1%E6%8C%87%E5%8D%97%20(1)%2011ae22a71e0c4e9b8e8be4ca9929968b/Untitled%2017.png)
    
- 詳細模型維度
    1. 確認維度/屬性 DIM/ATTRIBUTE
    2. 確認事件 FACT
    3. 確認緩面變化維度方式 SCD  ⇒ 應如何處理? 來源資料確認/調整邏輯/新增欄或列
    4. 詳細表設計文件
    5. 模型 ISSUE 追蹤
    6. 更新模型矩陣
- 審核模型
- 文件化設計文檔案(DES檔案)

## 18.4 小結

維度建模是迭代化過程, 從廣泛概念逐漸收斂至細節的欄位, 需要與不同面向的工作人員確認, 
詳細建模將深入到定義, 資源, 關係, 品質與轉換等需求問題, 滿足用戶的需求. 並為後期的 ETL 的進行提供明確方向與文件. 

## CH. 19 ETL 系統種類說明

Def: ETL(Extract Transformation Load) 獲取/轉換/載入

分為下列四種類:

- 來源系統獲取
    - Data Profiling (EX: [Apache AirFlow](https://airflow.apache.org/docs/apache-airflow/1.10.2/profiling.html) , [Apache Griffin](https://griffin.apache.org/docs/profiling.html)
    - Catch Data Change
    - Pull Data (EX: [Apache AirFlow](https://airflow.apache.org/docs/apache-airflow/stable/concepts/tasks.html)
- 資料清洗/監控/品質
    - Quality: Apache Griffin
    - Deduplication 去重
- 發布/傳送
- 管理

## 

## CH. 20 ETL 系統開發與技術

# Ref:

1. 数据仓库工具箱维度建模权威指南第3版
2. 愛奇異: [愛奇藝數據倉庫平台和服務建設實踐_愛奇藝技術 - MdEditor (gushiciku.cn)](https://www.gushiciku.cn/pl/pjbe/zh-hk)
